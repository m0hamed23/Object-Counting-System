<div class="monitor-container">
  <div class="control-panel">
    <div class="mode-controls">
      <div class="control-group">
        <h3>Operation Mode</h3>
        <div class="radio-group">
          <label>
            <input type="radio" name="mode" value="Manual" [(ngModel)]="mode" (change)="onModeChange()">
            <span class="radio-label">Manual</span>
          </label>
          <label>
            <input type="radio" name="mode" value="Automatic" [(ngModel)]="mode" (change)="onModeChange()">
            <span class="radio-label">Automatic</span>
          </label>
        </div>
      </div>
      <span class="ws-status" [class]="wsStatus">{{ wsStatus }}</span>
    </div>

    <div class="barrier-controls">
      <div class="control-group">
        <h3>Barrier Control</h3>
        <div class="button-group">
          <button class="primary" [disabled]="mode === 'Automatic' || wsStatus !== 'Connected'" (click)="openBarrier()">
            Open All Barriers
          </button>
          <button class="secondary" [disabled]="mode === 'Automatic' || wsStatus !== 'Connected'" (click)="closeBarrier()">
            Close All Barriers
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="camera-grid" *ngIf="!isLoadingSettings">
    <div *ngFor="let feed of cameraFeeds; let i = index" class="camera-container" [class.active]="feed.is_active">
      <div class="camera-header">
        <span class="camera-title">Camera {{feed.index + 1}}</span>
        <span class="status" [class]="feed.status.toLowerCase()">{{feed.status}}</span>
      </div>
      <div class="video-wrapper">
        <div class="video-container" #videoContainerRef>
          <img [src]="feed.display_url" alt="Camera Feed {{feed.index + 1}}" (load)="onImageLoad(feed.index)">
          
          <!-- Main SVG overlay for ROI. THE FIX IS HERE: (click) is moved to the svg element -->
          <svg class="roi-svg-overlay" [class.defining]="definingRoiFor === feed.index" (click)="addRoiPoint($event, feed.index)">
            <defs>
              <mask [attr.id]="'roi-mask-' + feed.index">
                <rect x="0" y="0" width="100%" height="100%" fill="white" />
                <polygon *ngIf="isRoiValid(feed.index)"
                         [attr.points]="getPolygonPoints(feed.index)"
                         fill="black" />
              </mask>
            </defs>

            <!-- Semi-transparent overlay for the area OUTSIDE the ROI -->
            <rect *ngIf="isRoiValid(feed.index)"
                  x="0" y="0" width="100%" height="100%"
                  class="roi-shadow-background"
                  [attr.mask]="getMaskUrl(feed.index)" />

            <!-- Visible border of the ROI polygon -->
            <polygon *ngIf="isRoiValid(feed.index)"
                     [attr.points]="getPolygonPoints(feed.index)"
                     class="roi-polygon-border" />

            <!-- Vertices (dots) shown while defining the ROI -->
            <ng-container *ngIf="definingRoiFor === feed.index && currentRois[feed.index]">
              <circle *ngFor="let point of currentRois[feed.index]"
                      class="roi-vertex"
                      [attr.cx]="point.x"
                      [attr.cy]="point.y" />
            </ng-container>
          </svg>
        </div>

        <div *ngIf="feed.status === 'Error'" class="error-overlay">
           <div class="overlay-content">
             <span class="error-message">{{ feed.message || 'Failed to connect or process stream.' }}</span>
             <button class="retry-button" (click)="toggleCamera(feed.index)" *ngIf="!feed.is_active">Retry Start</button>
           </div>
        </div>
        <div *ngIf="feed.status === 'Inactive' && !feed.rtsp_url && !feed.is_active" class="inactive-overlay">
          <div class="overlay-content">Webcam Inactive</div>
        </div>
        <div *ngIf="feed.status === 'Inactive' && feed.rtsp_url && !feed.is_active" class="inactive-overlay">
          <div class="overlay-content">Camera Inactive</div>
        </div>
        <div *ngIf="feed.status === 'Connecting' || feed.status === 'Reconnecting'" class="loading-overlay">
          <div class="overlay-content">
            <div class="loading-spinner"></div>
            <span>{{ feed.status }}...</span>
          </div>
        </div>
      </div>
      <div class="camera-controls">
        <button class="control-button" 
                [class.active]="feed.is_active" 
                (click)="toggleCamera(feed.index)" 
                [disabled]="wsStatus !== 'Connected'">
          {{feed.is_active ? 'Stop' : 'Start'}}
        </button>
        <button class="control-button" 
                [class.active]="definingRoiFor === feed.index" 
                (click)="toggleDefineRoi(feed.index)" 
                [disabled]="!feed.is_active || feed.status === 'Error' || feed.status === 'Connecting' || feed.status === 'Reconnecting' || wsStatus !== 'Connected'">
          {{ definingRoiFor === feed.index ? 'Cancel Definition' : 'Define New ROI' }}
        </button>
        <button class="control-button secondary" *ngIf="definingRoiFor === feed.index" (click)="cancelRoiDefinition(feed.index, false)">
          Clear Points
        </button>
        <button class="control-button confirm" *ngIf="definingRoiFor === feed.index" (click)="sendRoi(feed.index)" [disabled]="!isRoiValid(feed.index)">
          Send ROI
        </button>
      </div>
    </div>
  </div>
  <div *ngIf="isLoadingSettings" class="loading-message">
    <div class="loading-spinner"></div>
    <span>Loading settings...</span>
  </div>
</div>